/*
 kl/editor-manager/plugins/specialCharacters.plugin.js
 License https://creativecommons.org/licenses/by-nc-nd/4.0/legalcode
 Copyright 2020 Lukas Wieditz
*/
(function(d){d(document).on("editor:config",function(F,G,g){function z(){p();XF.EditorHelpers.blur(g.ed);var a=d(g.ed.$tb.find('.fr-command[data-cmd="specialCharacters"]')).first();if(!t){t=!0;d.trim(d(".js-xfEditorMenu").first().html());f=d(d.parseHTML(Mustache.render(d(".js-specialCharacters").first().html())));f.insertAfter(a);a.data("xf-click","menu");var h=XF.Event.getElementHandler(a,"menu","click");f.on("menu:complete",function(){l=f.find(".menu-scroller");if(!u){u=!0;l.find(".js-specialCharacter").on("click",
q);var c=f.find(".js-specialCharacterSearch");c.on("focus",p);c.on("blur",A);c.on("input",B);f.find(".js-specialCharsCloser").on("click",function(){XF.EditorHelpers.focus(g.ed)});d(document).on("recent-klem-special-character:logged",C);g.ed.events.on("commands.mousedown",function(e){"specialCharacters"!==e.data("cmd")&&h.close()});f.on("menu:closed",function(){v=l.scrollTop()})}l.scrollTop(v)});f.on("menu:closed",function(){setTimeout(function(){g.ed.markers.remove()},50)})}(a=a.data("xfClickHandlers"))&&
a.menu&&a.menu.toggle()}function q(a){var h=d(a.currentTarget);a=h.html().trim();XF.EditorHelpers.focus(g.ed);g.ed.html.insert(a);p();XF.EditorHelpers.blur(g.ed);if(f){var c=f.find(".js-specialCharacterInsertedRow");c.find(".js-specialCharacterInsert").html(a);c.addClassTransitioned("is-active");clearTimeout(w);w=setTimeout(function(){c.removeClassTransitioned("is-active")},1500)}clearTimeout(x);x=setTimeout(function(){var e=h.data("id");e=d.trim(e);var m=XF.Feature.has("hiddenscroll")?12:11,b=XF.Cookie.get("klem_specialcharacter_usage");
b=b?b.split(","):[];var k=b.indexOf(e);-1!==k&&b.splice(k,1);b.push(e);b.length>m&&(b=b.reverse().slice(0,m).reverse());XF.Cookie.set("klem_specialcharacter_usage",b.join(","),new Date((new Date).setFullYear((new Date).getFullYear()+1)));d(document).trigger("recent-klem-special-character:logged")},1500)}function B(){var a=d(this),h=f.find(".js-specialCharacterFullList"),c=f.find(".js-specialCharacterSearchResults");clearTimeout(y);y=setTimeout(function(){var e=a.val();if(!e||2>e.length)c.hide(),h.show();
else{var m=XF.canonicalizeUrl("index.php?editor/kl-em-special-chars/search");XF.ajax("GET",m,{q:e},function(b){b.html&&XF.setupHtmlInsert(b.html,function(k){k.find(".js-specialCharacter").on("click",q);h.hide();c.replaceWith(k)})})}},300)}function D(){var a=XF.Cookie.get("klem_specialcharacter_usage");return(a?a.split(","):[]).reverse()}function C(){var a=D(),h=l.find(".js-recentHeader"),c=l.find(".js-recentBlock"),e=c.find(".js-recentList"),m=l.find(".js-specialCharacterList");if(a){var b=e.clone(),
k=[];b.empty();for(var r in a){var E=a[r],n;m.each(function(){n=d(this).find('.js-specialCharacter[data-id="'+E+'"]').closest("li").clone();if(n.length)return n.find(".js-specialCharacter").on("click",q),k.push(n),!1})}for(r in k)k[r].appendTo(b);e.replaceWith(b);c.hasClass("is-hidden")&&(c.hide(),c.removeClass("is-hidden"),h.removeClass("is-hidden"),c.xfFadeDown(XF.config.speed.fast))}}function p(){g.ed.selection.save()}function A(){g.ed.selection.restore()}var t=!1,u=!1,f,l,v=0,w,x,y;d.FE.DefineIcon("klSpecialChars",
{NAME:"omega"});d.FE.RegisterCommand("specialCharacters",{title:"Special Characters",icon:"klSpecialChars",undo:!1,focus:!1,refreshOnCallback:!1,callback:function(){z()}})})})(jQuery);